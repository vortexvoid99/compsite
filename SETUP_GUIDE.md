# Cloudflare Pages Admin System Setup Guide

This guide details the steps required to set up the Cloudflare-native admin system for competition management.

## 1. Project Structure Changes

The following files and directories have been added to implement the new functionality:

| Path | Description |
| :--- | :--- |
| `schema.sql` | D1 database schema for the `competitions` table. |
| `src/types/competition.ts` | TypeScript interface for the competition data model. |
| `src/pages/Admin.tsx` | The new React component for the admin form at `/admin`. |
| `src/components/ui/input.tsx` | Reusable `Input` component for the admin form. |
| `src/components/ui/label.tsx` | Reusable `Label` component for the admin form. |
| `src/components/ui/textarea.tsx` | Reusable `Textarea` component for the admin form. |
| `functions/api/utils.ts` | Shared utilities for Pages Functions (slugify, JSON response, types, hashing). |
| `functions/api/competitions.ts` | Public API endpoint (`/api/competitions`) to list published competitions. |
| `functions/api/competitions/[slug].ts` | Public API endpoint (`/api/competitions/:slug`) to get a single competition and check puzzle answers. |
| `functions/api/admin/competitions.ts` | Protected Admin API endpoint (`/api/admin/competitions`) to create new competitions and handle R2 uploads. |
| `functions/r2-images/[...key].ts` | Pages Function to proxy R2 images, allowing them to be served from `/r2-images/*`. |

**Modified Files:**

*   `src/App.tsx`: Added the new `/admin` route.
*   `src/pages/Competitions.tsx`: Modified to fetch data from the new public API (`/api/competitions`) instead of using hardcoded data.
*   `src/components/CompetitionCard.tsx`: Modified to use the R2 key for the image source and the ISO timestamp for the countdown timer.

## 2. Cloudflare Setup (Required)

You must configure the following bindings in your Cloudflare Pages project settings.

### A. Cloudflare D1 Database

1.  **Create D1 Database:** In your Cloudflare dashboard, navigate to **D1** and create a new database (e.g., `competitions_db`).
2.  **Apply Schema:** Use the Cloudflare CLI (`wrangler`) or the dashboard to apply the schema from the `schema.sql` file to your new D1 database.
3.  **Create Binding:** In your Cloudflare Pages project settings, go to **Functions** -> **D1 database bindings**.
    *   **Variable Name:** `DB`
    *   **D1 Database:** Select the D1 database you created (e.g., `competitions_db`).

### B. Cloudflare R2 Storage

1.  **Create R2 Bucket:** In your Cloudflare dashboard, navigate to **R2** and create a new bucket (e.g., `competition-images`).
2.  **Create Binding:** In your Cloudflare Pages project settings, go to **Functions** -> **R2 bucket bindings**.
    *   **Variable Name:** `R2_BUCKET`
    *   **R2 Bucket:** Select the R2 bucket you created (e.g., `competition-images`).

### C. Cloudflare Access (Security)

1.  **Configure Access Policy:** In your Cloudflare dashboard, navigate to **Access** -> **Applications**.
2.  **Create a Self-Hosted Application:**
    *   **Application Type:** Self-hosted
    *   **Subdomain:** Your Pages custom domain (e.g., `compsite.yourdomain.com`)
    *   **Path:** `/admin*` (This will protect `/admin` and all API routes under `/api/admin/*`).
3.  **Create an Access Policy:**
    *   **Policy Name:** `Admin Access`
    *   **Action:** `Allow`
    *   **Include:** `Emails` (Enter your site owner email address).

## 3. Image Serving Configuration

The frontend is configured to fetch images from the path `/r2-images/*`. This path is handled by the `functions/r2-images/[...key].ts` Pages Function, which proxies the request to your R2 bucket.

**No additional configuration is needed for image serving, provided you have set up the `R2_BUCKET` binding as described above.**

## 4. Final Steps

1.  **Commit and Push:** Commit all the new and modified files to your GitHub repository.
2.  **Deploy:** Cloudflare Pages will automatically detect the changes and deploy the new application, including the Pages Functions.
3.  **Test:**
    *   Visit `/admin` and you should be prompted to log in via Cloudflare Access.
    *   Fill out the form, upload an image, and create a competition.
    *   Visit `/competitions` to see the new listing appear dynamically.

---
*Generated by Manus AI*
